@using CookStackShared.Recipes.Dtos
@using CookStackShared.Enums


<EditForm Model="@RecipeDto" OnValidSubmit="OnSubmit">
	<DataAnnotationsValidator/>
	<ValidationSummary/>

	<div class="mb-3">
		<label>Title</label>
		<InputText class="form-control" @bind-Value="RecipeDto.Title" />
	</div>

	<div class="mb-3">
		<label>Description</label>
		<InputText class="form-control" @bind-Value="RecipeDto.Description" />
	</div>

	<div class="mb-3">
		<label>Source URL</label>
		<InputText class="form-control" @bind-Value="RecipeDto.SourceUrl" />
	</div>

	<hr />

	<h5>Ingredients</h5>

	@foreach (var ingredient in RecipeDto.Ingredients)
	{
		<div class="row mb-2">
			<div class="col">
				<InputText class="form-control" @bind-Value="ingredient.Name" placeholder="Name" />
			</div>
			<div class="col">
				<InputNumber class="form-control" @bind-Value="ingredient.Quantity" TValue="decimal" />
			</div>
			<div class="col">
				<InputSelect class="form-control" @bind-Value="ingredient.Unit">
					@foreach(var unit in Enum.GetValues<UnitType>())
					{
						<option value="@unit">@unit</option>
					}
				</InputSelect>
			</div>
			<div class="col-auto">
				<button type="button" class="btn btn-danger" @onclick="() => RemoveIngredient(ingredient)">X</button>
			</div>
		</div>
	}

	<button type="button" class="btn btn-secondary mb-2" @onclick="AddIngredient">Add ingredient</button>

	<hr />

	<h5 class="mt-3">Steps</h5>

	@foreach (var step in RecipeDto.Steps)
	{
		<div class="row mb-2">
			<div class="col">
				<InputTextArea class="form-control" @bind-Value="step.Description"/>
			</div>
			<div class="col-auto">
				<button type="button" class="btn btn-danger" @onclick="() => RemoveStep(step)">X</button>
			</div>
		</div>
	}
		
	<button type="button" class="btn btn-secondary mb-2" @onclick="AddStep">Add step</button>

	<hr />

	<div class="my-2">
		<button type="submit" class="btn btn-primary">@SubmitText</button>
		<button type="button" class="btn btn-danger" @onclick="OnCancel">Cancel</button>
	</div>

	
</EditForm>

@code {

	[Parameter] public RecipeBaseDto RecipeDto { get; set; } = default!;
	[Parameter] public EventCallback OnSubmit { get; set; }
	[Parameter] public EventCallback OnCancel { get; set; }
	[Parameter] public string SubmitText { get; set; } = "Save";

	private void AddIngredient() => RecipeDto.Ingredients.Add(new());
	private void RemoveIngredient(RecipeIngredientDto i) => RecipeDto.Ingredients.Remove(i);

	private void AddStep()
	{
		RecipeDto.Steps.Add(new());
		SetStepsOrder();
	}

	private void RemoveStep(RecipeStepDto s)
	{
		RecipeDto.Steps.Remove(s);
		SetStepsOrder();
	}

	private void SetStepsOrder()
	{
		for (int i = 0; i < RecipeDto.Steps.Count; i++)
		{
			RecipeDto.Steps[i].Order = i + 1;
		}
	}
}

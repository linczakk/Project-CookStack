@using CookStackClient.Components
@using CookStackClient.Constants
@using CookStackClient.Services
@using CookStackShared.Recipes.Dtos

@page "/"
@page "/recipes"
@inject RecipesApiClient RecipesApi
@inject LoadingService LoadingService
@inject NavigationManager NavManager

<PageTitle>Recipes</PageTitle>


<ConfirmDialog @ref="confirmDialog" 
	Title="Delete recipe"
	Message="Are you sure you want to delete this recipe?"
	OnConfirm="ConfirmDelete" />

<h3>Recipes</h3>

@if (recipes != null)
{
	if(recipes.Count > 0)
	{
		<ul>
			@foreach (var recipe in recipes)
			{
				<li>
					<p>
						<label @onclick="() => GoToDetails(recipe.Id)">@recipe.Title</label>
						<button class="btn btn-primary btn-sm" @onclick="() => UpdateRecipe(recipe.Id)">
							Edit
						</button>
						<button class="btn btn-danger btn-sm" @onclick="() => AskDelete(recipe.Id)">
							Delete
						</button>
					</p>
				</li>
			}
		</ul>
	}
	else
	{
		<p>There are currently no added recipes</p>
		<br />
		<p>
			<button @onclick="AddRecipe">
				Add recipe
			</button>
		</p>
	}
}

@code {
	private List<RecipeListDto>? recipes;

	private ConfirmDialog? confirmDialog;
	private int deleteId;

	private bool recipesLoaded = false;

	protected override async Task OnInitializedAsync()
	{
		await LoadingService.RunWithLoading(async () =>
		{
			recipes = await RecipesApi.GetRecipesAsync();
		}, "Pobieranie przepisów...");


		if(recipes != null)
		{
			recipes = recipes.OrderBy(r => r.CreatedAt).ToList();
		}
	}

	private void GoToDetails(int id)
	{
		NavManager.NavigateTo(string.Format(Routes.RecipeDetails, id));
	}

	private void AddRecipe()
	{
		NavManager.NavigateTo(Routes.RecipeCreate);
	}

	private void UpdateRecipe(int id)
	{
		NavManager.NavigateTo(string.Format(Routes.RecipeUpdate, id));
	}

	private void AskDelete(int id)
	{
		deleteId = id;
		confirmDialog?.Show();
	}

	private async Task ConfirmDelete()
	{
		await DeleteRecipe(deleteId);
	}

	private async Task DeleteRecipe(int id)
	{
		var recipe = recipes.FirstOrDefault(r => r.Id == id);

		if (recipe == null)
			return;

		recipes.Remove(recipe);

		try
		{
			await RecipesApi.DeleteRecipeAsync(id);
		}
		catch (Exception ex)
		{
			recipes.Add(recipe);
			Console.Error.WriteLine(ex);

		}
	}
}
